hist(cmp$wilcox_pvals)
compare_with_wilcox <- function() {
set.seed(67890)
cat("Comparing Honest WMW vs wilcox.test() under H0: AUC = 0.5\n")
cat("=========================================================\n\n")
# Test the critical case: different scales
n1 <- 30
n2 <- 35
n_sims <- 10000
honest_pvals <- numeric(n_sims)
wilcox_pvals <- numeric(n_sims)
aucs <- numeric(n_sims)
cat(sprintf("Testing different scales scenario (n1=%d, n2=%d, sims=%d)\n", n1, n2, n_sims))
for (i in 1:n_sims) {
# Different scales: same median, different variance -> AUC = 0.5
x <- rnorm(n1, 0, 1) # 0.1) # 1
y <- rnorm(n2, 0, 2) #3) # 2
aucs[i] <- compute_empirical_auc(x, y)
honest_pvals[i] <- wmw_pvalue(x, y)
wilcox_pvals[i] <- wilcox.test(x, y)$p.value
}
return(list(honest_pvals = honest_pvals, wilcox_pvals = wilcox_pvals, aucs = aucs))
}
#
cmp = compare_with_wilcox()
hist(cmp$honest_pvals)
hist(cmp$wilcox_pvals)
source("~/2025/nov/wmwAUC/R/wmw_pvalue.R")
compare_with_wilcox <- function() {
set.seed(67890)
cat("Comparing Honest WMW vs wilcox.test() under H0: AUC = 0.5\n")
cat("=========================================================\n\n")
# Test the critical case: different scales
n1 <- 30
n2 <- 35
n_sims <- 10000
honest_pvals <- numeric(n_sims)
wilcox_pvals <- numeric(n_sims)
aucs <- numeric(n_sims)
cat(sprintf("Testing different scales scenario (n1=%d, n2=%d, sims=%d)\n", n1, n2, n_sims))
for (i in 1:n_sims) {
# Different scales: same median, different variance -> AUC = 0.5
x <- rnorm(n1, 0, 1) # 0.1) # 1
y <- rnorm(n2, 0, 2) #3) # 2
aucs[i] <- compute_empirical_auc(x, y)
honest_pvals[i] <- wmw_pvalue(x, y)
wilcox_pvals[i] <- wilcox.test(x, y)$p.value
}
return(list(honest_pvals = honest_pvals, wilcox_pvals = wilcox_pvals, aucs = aucs))
}
#
cmp = compare_with_wilcox()
#
cmp = compare_with_wilcox()
hist(cmp$honest_pvals)
hist(cmp$honest_pvals)
cmp$honest_pvals
source("~/2025/nov/wmwAUC/R/wmw_pvalue.R")
compare_with_wilcox <- function() {
set.seed(67890)
cat("Comparing Honest WMW vs wilcox.test() under H0: AUC = 0.5\n")
cat("=========================================================\n\n")
# Test the critical case: different scales
n1 <- 30
n2 <- 35
n_sims <- 10000
honest_pvals <- numeric(n_sims)
wilcox_pvals <- numeric(n_sims)
aucs <- numeric(n_sims)
cat(sprintf("Testing different scales scenario (n1=%d, n2=%d, sims=%d)\n", n1, n2, n_sims))
for (i in 1:n_sims) {
# Different scales: same median, different variance -> AUC = 0.5
x <- rnorm(n1, 0, 1) # 0.1) # 1
y <- rnorm(n2, 0, 2) #3) # 2
aucs[i] <- compute_empirical_auc(x, y)
honest_pvals[i] <- wmw_pvalue(x, y)
wilcox_pvals[i] <- wilcox.test(x, y)$p.value
}
return(list(honest_pvals = honest_pvals, wilcox_pvals = wilcox_pvals, aucs = aucs))
}
#
cmp = compare_with_wilcox()
hist(cmp$honest_pvals)
hist(cmp$wilcox_pvals)
hist(cmp$honest_pvals)
compare_wilcox_vs_honest <- function(n1, n2, nsim = 2000) {
pvals_wilcox <- numeric(nsim)
pvals_honest <- numeric(nsim)
aucs_empirical <- numeric(nsim)
for (i in 1:nsim) {
# Generate N(0,1) vs N(0,2) - different variances, same means
x <- rnorm(n1, mean = 0, sd = 1)
y <- rnorm(n2, mean = 0, sd = 2)
# Empirical AUC
auc_emp <- mean(outer(x, y, ">")) + 0.5 * mean(outer(x, y, "=="))
aucs_empirical[i] <- auc_emp
# Standard wilcox.test (tests H0: F = G)
wilcox_result <- wilcox.test(x, y, exact = FALSE)
pvals_wilcox[i] <- wilcox_result$p.value
# Our honest implementation (tests H0: AUC = 0.5)
lambda_n <- n1 / (n1 + n2)
# Placement values
G_x_vals <- sapply(x, function(xi) mean(y <= xi))
F_y_vals <- sapply(y, function(yj) mean(x <= yj))
# Variance estimates with bias correction
var_G_X_naive <- sum((G_x_vals - 0.5)^2) / (n1 - 1)
var_F_Y_naive <- sum((F_y_vals - 0.5)^2) / (n2 - 1)
omega_1_hat <- sum(G_x_vals * (1 - G_x_vals)) / n1
omega_2_hat <- sum(F_y_vals * (1 - F_y_vals)) / n2
var_G_X_corrected <- var_G_X_naive - omega_1_hat / n2
var_F_Y_corrected <- var_F_Y_naive - omega_2_hat / n1
# Skip if over-correction
if (var_G_X_corrected <= 0 || var_F_Y_corrected <= 0) {
pvals_honest[i] <- NA
next
}
sigma_sq_adj <- var_G_X_corrected / lambda_n + var_F_Y_corrected / (1 - lambda_n)
# Second-order correction
correction_factor <- (1 - 1/n1 - 1/n2)
sigma_sq_final <- correction_factor * sigma_sq_adj
# Test statistic and p-value
t_stat <- sqrt(n1 + n2) * (auc_emp - 0.5) / sqrt(sigma_sq_final)
df <- sigma_sq_final^2 / ((var_G_X_corrected / lambda_n * correction_factor)^2 / (n1 - 1) +
(var_F_Y_corrected / (1 - lambda_n) * correction_factor)^2 / (n2 - 1))
pvals_honest[i] <- 2 * pt(-abs(t_stat), df = df)
}
# Remove NAs
valid_indices <- !is.na(pvals_honest)
pvals_honest_clean <- pvals_honest[valid_indices]
cat("COMPARISON: N(0,1) vs N(0,2)\n")
cat("Sample sizes: n1 =", n1, ", n2 =", n2, "\n")
cat("True AUC = 0.5 (despite different variances)\n\n")
cat("Empirical AUC statistics:\n")
cat("  Mean:", round(mean(aucs_empirical), 4), "\n")
cat("  SD:", round(sd(aucs_empirical), 4), "\n\n")
cat("First bin [0, 0.05] proportions:\n")
cat("  wilcox.test:", sprintf("%.4f", mean(pvals_wilcox <= 0.05)), "\n")
cat("  Our honest implementation:", sprintf("%.4f", mean(pvals_honest_clean <= 0.05)), "\n")
cat("  Expected: 0.05\n\n")
# Test uniformity
ks_wilcox <- ks.test(pvals_wilcox, punif)
ks_honest <- ks.test(pvals_honest_clean, punif)
cat("KS test p-values (testing uniformity):\n")
cat("  wilcox.test:", sprintf("%.4f", ks_wilcox$p.value), "\n")
cat("  Our implementation:", sprintf("%.4f", ks_honest$p.value), "\n\n")
cat("Uniformity achieved:\n")
cat("  wilcox.test:", ifelse(ks_wilcox$p.value > 0.05, "YES ✓", "NO ✗"), "\n")
cat("  Our implementation:", ifelse(ks_honest$p.value > 0.05, "YES ✓", "NO ✗"), "\n\n")
# Compare with homoscedastic case N(0,1) vs N(0,1)
cat("=== COMPARISON WITH HOMOSCEDASTIC CASE N(0,1) vs N(0,1) ===\n")
pvals_homo_wilcox <- numeric(500)
pvals_homo_honest <- numeric(500)
for (i in 1:500) {
x_homo <- rnorm(n1, mean = 0, sd = 1)
y_homo <- rnorm(n2, mean = 0, sd = 1)
# wilcox.test
wilcox_homo <- wilcox.test(x_homo, y_homo, exact = FALSE)
pvals_homo_wilcox[i] <- wilcox_homo$p.value
# Our implementation (simplified)
auc_homo <- mean(outer(x_homo, y_homo, ">")) + 0.5 * mean(outer(x_homo, y_homo, "=="))
G_x_homo <- sapply(x_homo, function(xi) mean(y_homo <= xi))
F_y_homo <- sapply(y_homo, function(yj) mean(x_homo <= yj))
var_G_homo <- sum((G_x_homo - 0.5)^2) / (n1 - 1) - sum(G_x_homo * (1 - G_x_homo)) / n1 / n2
var_F_homo <- sum((F_y_homo - 0.5)^2) / (n2 - 1) - sum(F_y_homo * (1 - F_y_homo)) / n2 / n1
if (var_G_homo > 0 && var_F_homo > 0) {
sigma_homo <- (var_G_homo / lambda_n + var_F_homo / (1 - lambda_n)) * correction_factor
t_homo <- sqrt(n1 + n2) * (auc_homo - 0.5) / sqrt(sigma_homo)
pvals_homo_honest[i] <- 2 * pt(-abs(t_homo), df = 50)  # Approximate df
} else {
pvals_homo_honest[i] <- NA
}
}
pvals_homo_honest_clean <- pvals_homo_honest[!is.na(pvals_homo_honest)]
cat("Homoscedastic N(0,1) vs N(0,1):\n")
cat("  wilcox.test first bin:", sprintf("%.4f", mean(pvals_homo_wilcox <= 0.05)), "\n")
cat("  Our implementation first bin:", sprintf("%.4f", mean(pvals_homo_honest_clean <= 0.05)), "\n\n")
# Show variance estimates for both cases
cat("=== VARIANCE ANALYSIS ===\n")
# Single example for heteroscedastic case
x_ex <- rnorm(n1, 0, 1)
y_ex <- rnorm(n2, 0, 2)
G_x_ex <- sapply(x_ex, function(xi) mean(y_ex <= xi))
F_y_ex <- sapply(y_ex, function(yj) mean(x_ex <= yj))
var_G_ex <- sum((G_x_ex - 0.5)^2) / (n1 - 1) - sum(G_x_ex * (1 - G_x_ex)) / n1 / n2
var_F_ex <- sum((F_y_ex - 0.5)^2) / (n2 - 1) - sum(F_y_ex * (1 - F_y_ex)) / n2 / n1
sigma_hetero <- (var_G_ex / lambda_n + var_F_ex / (1 - lambda_n)) * correction_factor
cat("Heteroscedastic case variance estimate: σ̂² =", round(sigma_hetero, 4), "\n")
cat("Theoretical σ² = 0.25\n")
cat("Ratio:", round(sigma_hetero / 0.25, 3), "\n")
return(list(
wilcox_first_bin = mean(pvals_wilcox <= 0.05),
honest_first_bin = mean(pvals_honest_clean <= 0.05),
wilcox_uniform = ks_wilcox$p.value > 0.05,
honest_uniform = ks_honest$p.value > 0.05
))
}
# Test the specific case mentioned
cat("=== DIAGNOSTIC: N(0,1) vs N(0,2) with n1=n2=30 ===\n\n")
result <- compare_wilcox_vs_honest(30, 30, nsim = 2000)
# Also test with equal sample sizes to be sure
cat("\n", rep("=", 70), "\n\n")
cat("Testing with equal variances for comparison:\n")
result_equal <- compare_wilcox_vs_honest(30, 30, nsim = 1000)
compare_with_wilcox <- function() {
set.seed(67890)
cat("Comparing Honest WMW vs wilcox.test() under H0: AUC = 0.5\n")
cat("=========================================================\n\n")
# Test the critical case: different scales
n1 <- 300
n2 <- 350
n_sims <- 1000
honest_pvals <- numeric(n_sims)
wilcox_pvals <- numeric(n_sims)
aucs <- numeric(n_sims)
cat(sprintf("Testing different scales scenario (n1=%d, n2=%d, sims=%d)\n", n1, n2, n_sims))
for (i in 1:n_sims) {
# Different scales: same median, different variance -> AUC = 0.5
x <- rnorm(n1, 0, 1) # 0.1) # 1
y <- rnorm(n2, 0, 2) #3) # 2
aucs[i] <- compute_empirical_auc(x, y)
honest_pvals[i] <- wmw_pvalue(x, y)
wilcox_pvals[i] <- wilcox.test(x, y)$p.value
}
return(list(honest_pvals = honest_pvals, wilcox_pvals = wilcox_pvals, aucs = aucs))
}
#
cmp = compare_with_wilcox()
hist(cmp$honest_pvals)
hist(cmp$wilcox_pvals)
hist(cmp$honest_pvals)
hist(cmp$wilcox_pvals)
compare_with_wilcox <- function() {
set.seed(67890)
cat("Comparing Honest WMW vs wilcox.test() under H0: AUC = 0.5\n")
cat("=========================================================\n\n")
# Test the critical case: different scales
n1 <- 1000 # 30
n2 <- 1000 # 35
n_sims <- 1000
honest_pvals <- numeric(n_sims)
wilcox_pvals <- numeric(n_sims)
aucs <- numeric(n_sims)
cat(sprintf("Testing different scales scenario (n1=%d, n2=%d, sims=%d)\n", n1, n2, n_sims))
for (i in 1:n_sims) {
# Different scales: same median, different variance -> AUC = 0.5
x <- rnorm(n1, 0, 1) # 0.1) # 1
y <- rnorm(n2, 0, 2) #3) # 2
aucs[i] <- compute_empirical_auc(x, y)
honest_pvals[i] <- wmw_pvalue(x, y)
wilcox_pvals[i] <- wilcox.test(x, y)$p.value
}
return(list(honest_pvals = honest_pvals, wilcox_pvals = wilcox_pvals, aucs = aucs))
}
#
cmp = compare_with_wilcox()
hist(cmp$honest_pvals)
hist(cmp$wilcox_pvals)
compare_with_wilcox <- function() {
set.seed(67890)
cat("Comparing Honest WMW vs wilcox.test() under H0: AUC = 0.5\n")
cat("=========================================================\n\n")
# Test the critical case: different scales
n1 <- 1000 # 30
n2 <- 1000 # 35
n_sims <- 1000
honest_pvals <- numeric(n_sims)
wilcox_pvals <- numeric(n_sims)
aucs <- numeric(n_sims)
cat(sprintf("Testing different scales scenario (n1=%d, n2=%d, sims=%d)\n", n1, n2, n_sims))
for (i in 1:n_sims) {
# Different scales: same median, different variance -> AUC = 0.5
x <- rnorm(n1, 0, 0.5) # 0.1) # 1
y <- rnorm(n2, 0, 2.5) #3) # 2
aucs[i] <- compute_empirical_auc(x, y)
honest_pvals[i] <- wmw_pvalue(x, y)
wilcox_pvals[i] <- wilcox.test(x, y)$p.value
}
return(list(honest_pvals = honest_pvals, wilcox_pvals = wilcox_pvals, aucs = aucs))
}
#
cmp = compare_with_wilcox()
hist(cmp$honest_pvals)
hist(cmp$wilcox_pvals)
hist(cmp$honest_pvals)
compare_with_wilcox <- function() {
set.seed(67890)
cat("Comparing Honest WMW vs wilcox.test() under H0: AUC = 0.5\n")
cat("=========================================================\n\n")
# Test the critical case: different scales
n1 <- 1000 # 30
n2 <- 1000 # 35
n_sims <- 1000
honest_pvals <- numeric(n_sims)
wilcox_pvals <- numeric(n_sims)
aucs <- numeric(n_sims)
cat(sprintf("Testing different scales scenario (n1=%d, n2=%d, sims=%d)\n", n1, n2, n_sims))
for (i in 1:n_sims) {
# Different scales: same median, different variance -> AUC = 0.5
x <- rnorm(n1, 0, 0.25) # 0.1) # 1
y <- rnorm(n2, 0, 2.75) #3) # 2
aucs[i] <- compute_empirical_auc(x, y)
honest_pvals[i] <- wmw_pvalue(x, y)
wilcox_pvals[i] <- wilcox.test(x, y)$p.value
}
return(list(honest_pvals = honest_pvals, wilcox_pvals = wilcox_pvals, aucs = aucs))
}
#
cmp = compare_with_wilcox()
hist(cmp$honest_pvals)
hist(cmp$wilcox_pvals)
hist(cmp$honest_pvals)
hist(cmp$wilcox_pvals)
ks.test(cmp$honest_pvals)
?ks.test
ks.test(cmp$honest_pvals, 'dunif')
ks.test(cmp$wilcox_pvals, 'dunif')
source("~/2025/nov/wmwAUC/R/wmw_pvalue_asymptotic.R")
#
cmp = compare_with_wilcox()
hist(cmp$honest_pvals)
hist(cmp$wilcox_pvals)
ks.test(cmp$wilcox_pvals, 'punif')
ks.test(cmp$honest_pvals, 'punif')
source("~/2025/nov/wmwAUC/R/wmw_pvalue.R")
compare_with_wilcox <- function() {
set.seed(67890)
cat("Comparing Honest WMW vs wilcox.test() under H0: AUC = 0.5\n")
cat("=========================================================\n\n")
# Test the critical case: different scales
n1 <- 1000 # 30
n2 <- 1000 # 35
n_sims <- 1000
honest_pvals <- numeric(n_sims)
wilcox_pvals <- numeric(n_sims)
aucs <- numeric(n_sims)
cat(sprintf("Testing different scales scenario (n1=%d, n2=%d, sims=%d)\n", n1, n2, n_sims))
for (i in 1:n_sims) {
# Different scales: same median, different variance -> AUC = 0.5
x <- rnorm(n1, 0, 0.1) # 0.1) # 1
y <- rnorm(n2, 0, 3) #3) # 2
aucs[i] <- compute_empirical_auc(x, y)
honest_pvals[i] <- wmw_pvalue(x, y)
wilcox_pvals[i] <- wilcox.test(x, y)$p.value
}
return(list(honest_pvals = honest_pvals, wilcox_pvals = wilcox_pvals, aucs = aucs))
}
#
cmp = compare_with_wilcox()
hist(cmp$honest_pvals)
hist(cmp$wilcox_pvals)
#
ks.test(cmp$honest_pvals, 'punif')
ks.test(cmp$wilcox_pvals, 'punif')
data(MS)
da <- MS
# preparing data frame
class(da$proteins) <- setdiff(class(da$proteins), "AsIs")
df <- as.data.frame(da$proteins)
df$MS <- da$MS
# WMW test
wmd <- wmw_test(P19099 ~ MS, data = df, ref_level = 'no')
wmd
plot(wmd)
wilcox.test(P19099 ~ MS, data = df)
data(Ex2)
da <- Ex2
# WMW test
wmd <- wmw_test(y ~ group, data = da, ref_level = 'control')
wmd
plot(wmd)
wilcox.test(y ~ group, data = da)
qp <- quadruplot(y ~ group, data = da, ref_level = 'control')
qp
plot(wmd)
0.003197
0.003197/2
library('gss')
data(wesdr)
da = wesdr
da$ret = as.factor(da$ret)
# WMW
wmd <- wmw_test(bmi ~ ret, data = da, ref_level = '0')
wmd
plot(wmd)
qp <- quadruplot(bmi ~ ret, data = da, ref_level = '0')
qp
wilcox.test(bmi ~ ret, data = da)
compute_empirical_auc(x= da$bmi[da$ret == '0'], y= da$bmi[da$ret == '1'])
1 - 0.4533708
compute_empirical_auc(x= da$bmi[da$ret == '1'], y= da$bmi[da$ret == '0'])
library(help = wmwAUC)
library('gemR')
data(MS)
da <- MS
# preparing data frame
class(da$proteins) <- setdiff(class(da$proteins), "AsIs")
df <- as.data.frame(da$proteins)
df$MS <- da$MS
# WMW test
wmd <- wmw_test(P19099 ~ MS, data = df, ref_level = 'no')
wmd
plot(wmd)
N = 10000
n = 1000
set.seed(123L)
pval = eauc = numeric(N)
for (i in 1:N) {
#
x = rnorm(n, sd = 0.1)
y = rnorm(n, sd = 3)
wmt = wilcox.exact(x, y)
pval[i] = wmt$p.value
eauc[i] = wmt$statistic/(n*n)
#
}
hist(eauc)
N = 10000
n = 1000
set.seed(123L)
pval = eauc = numeric(N)
for (i in 1:N) {
#
x = rnorm(n, sd = 0.1)
y = rnorm(n, sd = 3)
wt = wilcox.test(x, y)
pval_wt[i] = wt$p.value
eauc[i] = wt$statistic/(n*n)
#
pval_wmw[i] = wmw_pvalue(x, y)
#
}
N = 10000
n = 1000
set.seed(123L)
pval_wt = pval_wmw = eauc = numeric(N)
for (i in 1:N) {
#
x = rnorm(n, sd = 0.1)
y = rnorm(n, sd = 3)
wt = wilcox.test(x, y)
pval_wt[i] = wt$p.value
eauc[i] = wt$statistic/(n*n)
#
pval_wmw[i] = wmw_pvalue(x, y)
#
}
hist(eauc)
hist(pval_wt)
hist(pval_wmw)
ks.test(pval_wt, 'punif')
ks.test(pval_wmw, 'punif')
?save
save(list(eauc, pval_wt, pval_wmw), file = 'Ex1.rda')
save(list = list(eauc, pval_wt, pval_wmw), file = 'Ex1.rda')
save(eauc, pval_wt, pval_wmw, file = 'Ex1.rda')
source("~/2025/nov/wmwAUC/R/wmw_test.R")
library(help = 'wmwAUC')
data(simulation1)  # Loads eauc, pval_traditional, pval_honest
hist(eauc)
hist(pval_wt)
hist(pval_wmw)
x = rnorm(n, sd = 0.1)
y = rnorm(n, sd = 3)
hist(x)
hist(y)
dd = data.frame(response = c(x,y), group = as.factor(c(rep('0', 1000), rep('1', 1000) )))
qp = quadruplot(response ~ group, dd)
qp = quadruplot(response ~ group, dd, '0')
qp
N = 10000
n = 1000
set.seed(123L)
pval = eauc = numeric(N)
for (i in 1:N) {
#
x = rnorm(n, 0, sd = 0.1)
y = rnorm(n, 0.5, sd = 3)
wmt = wilcox.test(x, y)
pval[i] = wmt$p.value
eauc[i] = wmt$statistic/(n*n)
#
}
hist(eauc)
hist(pval)
N = 10000
n = 1000
set.seed(123L)
pval_wt = pval_wmw = eauc = numeric(N)
for (i in 1:N) {
#
x = rnorm(n, 0, sd = 0.1)
y = rnorm(n, 0.5, sd = 3)
wt = wilcox.test(x, y)
pval_wt[i] = wt$p.value
eauc[i] = wt$statistic/(n*n)
pval_wmw[i] = wmw_pvalue(x, y)
#
}
save(eauc, pval_wt, pval_wmw, file = 'simulation2.rda')
hist(pval)
hist(eauc)
hist(pval_wt)
hist(pval_wmw)
hist(eauc)
library(password)
password(20)
password(20)
password(20)
password(20)
library(help = wmwAUC)
?wmw_test
?wmw_test
